<script src='https://cdn.jsdelivr.net/npm/web3@3.0.0-rc.5/dist/web3.min.js'></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>

<style>
	a,.nft{cursor:pointer}
	.boxnft{display:inline-block}
	.nobreed{opacity:0.5}
	.hide{display:none};
</style>

<a id="connect" onclick="ethereum.request({method:'eth_requestAccounts'})" class="hide">Connect<br/></a>

<b><p id="name"></p></b>

<div id="root" class="hide">
<a id="mint" onclick="MINT()">MINT (</a><br/>
<a id="breed" onclick="BREED()" class="hide">BREED</a> <a id="lblBreed"></a><div id="breed1" class="boxnft"></div> <div id="breed2" class="boxnft"></div>

<p id="myWH"></p><br/>
</div>

<script type="text/javascript">
var myWH=new Array();
var breed1,breed2;

async function loadMyOwl(){
	const arr=await contract.methods.getWallet(await getCurrentAccount()).call();
	for(let i=0;i<arr.length;i++){
		myWH[i]=new Array();
		await contract.methods.ac(arr[i]).call().then(d=>{for(let j=0;j<5;j++)myWH[i][j]=d[j+1];}); //parent1 parent2 time gen sex
		//await contract.methods.tokenURI(arr[i]).call(); //tokenURI
		await $.getJSON('https://raw.githubusercontent.com/aloycwl/erctest/main/1.json',function(d){
			myWH[i][5]=d.name+'#'+arr[i];
			myWH[i][6]=d.image;
			myWH[i][7]=arr[i]; //token id
		});
		var breedable;
		await contract.methods.age(parseInt(myWH[i][3])+1).call().then(d=>{breedable=d[2];})
		$('#myWH').append(
			'<p id="o'+arr[i]+'" class="boxnft"><b>'+myWH[i][5]+
			'</b><br/>Parents ID: '+myWH[i][0]+' + '+myWH[i][1]+
			'<br/>Last breeded: '+(myWH[i][2]>0?moment(moment.unix(myWH[i][2])).fromNow():'Since forever')+
			'<br/>Generation: '+myWH[i][3]+' ('+(myWH[i][4]==0?'Female':'Male')+')<br/><img src="'+
			(moment.duration(moment().diff(moment(moment.unix(myWH[i][2])))).asSeconds()>/*60480*/0&&breedable==true?
				myWH[i][6]+'" onclick="loadImg('+i+')" class="nft':
				myWH[i][6]+'" class="nobreed')
			 +'"></p>'
		);
	}
}
async function loadImg(p1){
	var s1='<img onclick="unloadImg()" src="';
	var s2='" class="nft">';
	if($('#breed1').is(':empty')){
		$('#breed1').html(s1+myWH[p1][6]+s2);
		breed1=myWH[p1][7];
		hideOwls(p1);
	}else if($('#breed2').is(':empty')){
		$('#breed2').html(s1+myWH[p1][6]+s2);
		breed2=myWH[p1][7];
		hideOwls(p1);
	}else return;
	if(!$('#breed1').is(':empty')&&!$('#breed2').is(':empty')){
		$('#breed').show();
		await contract.methods.age(parseInt(myWH[p1][3])+1).call().then(d=>{$('#lblBreed').html('('+d[1]+'/'+d[0]+')');});
	}
}
async function unloadImg(){
	$('#breed1').empty();
	$('#breed2').empty();
	$('#lblBreed').empty();
	breed1=null;
	breed2=null;
	$('#breed').hide();
	for(let i=0;i<myWH.length;i++)$('#o'+myWH[i][7]).show();
}
async function hideOwls(p1){
	for(let i=0;i<myWH.length;i++){
			if(myWH[i][4]==myWH[p1][4]||myWH[i][3]!=myWH[p1][3])$('#o'+myWH[i][7]).hide();
			if(myWH[i][0]==myWH[p1][7])$('#o'+myWH[i][1]).hide();
			if(myWH[i][1]==myWH[p1][7])$('#o'+myWH[i][0]).hide();
	}
}
async function getCurrentAccount(){
	const accounts=await web3.eth.getAccounts();
	return accounts[0];
}
async function MINT(){
	await contract.methods.MINT().send({
		from:await getCurrentAccount(),
		gas:250000,
		value:0000000000000000000 //0880000000000000000, DEPLOYMENT
	});
	location.reload();
}
async function BREED(){
	await contract.methods.BREED(breed1,breed2).send({
		from:await getCurrentAccount(),
		gas:400000,
		value:0000000000000000000 //0020000000000000000, DEPLOYMENT
	});
	location.reload();
}
async function load(){
	if(ethereum){
		web3=new Web3(ethereum);
		ethereum.enable();
	}
	contract=new web3.eth.Contract(
		[{"anonymous":!1,"inputs":[{"indexed":!0,"internalType":"address","name":"owner","type":"address"},{"indexed":!0,"internalType":"address","name":"approved","type":"address"},{"indexed":!0,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":!1,"inputs":[{"indexed":!0,"internalType":"address","name":"owner","type":"address"},{"indexed":!0,"internalType":"address","name":"operator","type":"address"},{"indexed":!1,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":!1,"inputs":[{"indexed":!0,"internalType":"address","name":"from","type":"address"},{"indexed":!0,"internalType":"address","name":"to","type":"address"},{"indexed":!0,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"operator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"}]
		,'0x42CB358f930A81d8F52332708aCC2F634b0f40aF');
	$('#name').append(await contract.methods.name.call().call()+' ('+await contract.methods.symbol.call().call()+') '+
		await contract.methods.getBalance.call().call()+' balance');
	await contract.methods.age(1).call().then(d=>{$('#mint').append(d[1]+'/'+d[0]+')');});
}
var loaded=false;
async function isWeb3(){
  await web3.eth.getAccounts().then(r=>{
    if(r.length>0){ 
			$('#connect').hide();
			$('#root').show();
			if($('#myWH').is(':empty')&&loaded==false){
				loadMyOwl();
				loaded=true;
			}
    }else{
			$('#connect').show();
			$('#root').hide();
    }
  });
}
load();
setInterval(isWeb3,2000);
</script>